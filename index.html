<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Veo3 Video Generator</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    input { padding: 10px; width: 400px; margin-right: 10px; }
    button { padding: 10px; }
    #status { margin-top: 10px; font-weight: bold; }
    video { display: block; margin-top: 20px; max-width: 100%; }
    .history { margin-top: 30px; }
    .history-item { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>Veo3 Text-to-Video Generator</h1>

  <input id="prompt" placeholder="Type your video prompt here" />
  <button id="generate">Generate Video</button>
  <p id="status"></p>

  <video id="result" controls></video>

  <div class="history">
    <h2>Generated Videos</h2>
    <div id="history-container"></div>
  </div>

  <script>
    // Replace this with your deployed Supabase Edge Function URL
    const EDGE_FUNCTION_URL = "https://cbqrmfgnluejsicjqpma.functions.supabase.co/generate_video";

    async function submitPrompt(prompt) {
      // Call your Edge Function
      const res = await fetch(EDGE_FUNCTION_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt })
      });
      const data = await res.json();
      return data.task_id; // Receive the task_id immediately
    }

    async function pollVeo(taskId) {
      // Poll Veo3API until the video is ready
      const VEO_API_KEY = "sk-4dea413565fb4e3faacc29a5324dfc66"; // Keep private! Edge Function hides it for production

      async function poll() {
        const statusRes = await fetch(`https://veo3api.com/status/${taskId}`, {
          headers: {
            "Authorization": `Bearer ${VEO_API_KEY}`,
            "Content-Type": "application/json"
          }
        });
        const statusData = await statusRes.json();

        if (statusData.data.status === "completed") {
          return statusData.data.video_url;
        } else if (statusData.data.status === "failed") {
          throw new Error("Video generation failed");
        } else {
          document.getElementById("status").textContent = "Generating video...";
          await new Promise(r => setTimeout(r, 3000));
          return poll();
        }
      }

      return await poll();
    }

    function addVideoToHistory(prompt, url) {
      const container = document.getElementById("history-container");
      const div = document.createElement("div");
      div.className = "history-item";
      div.innerHTML = `
        <strong>Prompt:</strong> ${prompt}<br>
        <video src="${url}" controls></video>
      `;
      container.prepend(div);
    }

    document.getElementById("generate").addEventListener("click", async () => {
      const prompt = document.getElementById("prompt").value.trim();
      if (!prompt) {
        alert("Please enter a prompt!");
        return;
      }

      document.getElementById("status").textContent = "Submitting prompt...";
      try {
        const taskId = await submitPrompt(prompt);
        document.getElementById("status").textContent = "Prompt submitted! Waiting for video...";
        const videoUrl = await pollVeo(taskId);
        document.getElementById("status").textContent = "Video ready!";
        document.getElementById("result").src = videoUrl;
        addVideoToHistory(prompt, videoUrl);
      } catch (err) {
        console.error(err);
        document.getElementById("status").textContent = err.message;
      }
    });
  </script>
</body>
</html>
